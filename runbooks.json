{
  "k8s.render": {
    "description": "Render kustomize overlay via kubectl kustomize.",
    "tags": ["k8s", "gitops"],
    "inputs": ["overlay", "kubeconfig", "sops_age_key_file"],
    "steps": [
      {
        "id": "render",
        "tool": "mcp_local",
        "args": {
          "action": "exec",
          "command": "kubectl",
          "args": ["kustomize", "{{ input.overlay }}"],
          "env": {
            "KUBECONFIG": "{{ input.kubeconfig }}",
            "SOPS_AGE_KEY_FILE": "{{ ?input.sops_age_key_file }}"
          },
          "inline": true
        }
      }
    ]
  },
  "k8s.diff": {
    "description": "Render and diff against cluster.",
    "tags": ["k8s", "gitops", "read"],
    "inputs": ["overlay", "kubeconfig", "sops_age_key_file"],
    "steps": [
      {
        "id": "render",
        "tool": "mcp_local",
        "args": {
          "action": "exec",
          "command": "kubectl",
          "args": ["kustomize", "{{ input.overlay }}"],
          "env": {
            "KUBECONFIG": "{{ input.kubeconfig }}",
            "SOPS_AGE_KEY_FILE": "{{ ?input.sops_age_key_file }}"
          },
          "inline": true
        }
      },
      {
        "id": "diff",
        "tool": "mcp_local",
        "args": {
          "action": "exec",
          "command": "kubectl",
          "args": ["diff", "-f", "-"],
          "stdin": "{{ steps.render.stdout }}",
          "env": {
            "KUBECONFIG": "{{ input.kubeconfig }}"
          },
          "inline": true
        }
      }
    ]
  },
  "k8s.apply": {
    "description": "Render and apply to cluster.",
    "tags": ["k8s", "gitops", "write"],
    "inputs": ["overlay", "kubeconfig", "sops_age_key_file"],
    "steps": [
      {
        "id": "render",
        "tool": "mcp_local",
        "args": {
          "action": "exec",
          "command": "kubectl",
          "args": ["kustomize", "{{ input.overlay }}"],
          "env": {
            "KUBECONFIG": "{{ input.kubeconfig }}",
            "SOPS_AGE_KEY_FILE": "{{ ?input.sops_age_key_file }}"
          },
          "inline": true
        }
      },
      {
        "id": "apply",
        "tool": "mcp_local",
        "args": {
          "action": "exec",
          "command": "kubectl",
          "args": ["apply", "-f", "-"],
          "stdin": "{{ steps.render.stdout }}",
          "env": {
            "KUBECONFIG": "{{ input.kubeconfig }}"
          },
          "inline": true
        }
      }
    ]
  },
  "k8s.rollout.inspect": {
    "description": "Inspect rollout/deployment and related pods by selector.",
    "tags": ["k8s", "diagnostic", "read"],
    "inputs": ["kubeconfig", "namespace", "selector", "workload_kind", "workload_name", "logs", "tail_lines"],
    "steps": [
      {
        "id": "rollouts",
        "tool": "mcp_local",
        "continue_on_error": true,
        "args": {
          "action": "exec",
          "command": "kubectl",
          "args": ["-n", "{{ input.namespace }}", "get", "rollouts"],
          "env": {
            "KUBECONFIG": "{{ ?input.kubeconfig }}"
          },
          "inline": true
        }
      },
      {
        "id": "deployments",
        "tool": "mcp_local",
        "continue_on_error": true,
        "args": {
          "action": "exec",
          "command": "kubectl",
          "args": ["-n", "{{ input.namespace }}", "get", "deploy"],
          "env": {
            "KUBECONFIG": "{{ ?input.kubeconfig }}"
          },
          "inline": true
        }
      },
      {
        "id": "pods",
        "tool": "mcp_local",
        "continue_on_error": true,
        "args": {
          "action": "exec",
          "command": "kubectl",
          "args": ["-n", "{{ input.namespace }}", "get", "pods", "-l", "{{ input.selector }}", "-o", "wide"],
          "env": {
            "KUBECONFIG": "{{ ?input.kubeconfig }}"
          },
          "inline": true
        }
      },
      {
        "id": "describe_workload",
        "tool": "mcp_local",
        "continue_on_error": true,
        "args": {
          "action": "exec",
          "command": "kubectl",
          "args": ["-n", "{{ input.namespace }}", "describe", "{{ input.workload_kind }}", "{{ input.workload_name }}"],
          "env": {
            "KUBECONFIG": "{{ ?input.kubeconfig }}"
          },
          "inline": true
        }
      },
      {
        "id": "pod_name",
        "tool": "mcp_local",
        "continue_on_error": true,
        "args": {
          "action": "exec",
          "command": "kubectl",
          "args": ["-n", "{{ input.namespace }}", "get", "pods", "-l", "{{ input.selector }}", "-o", "jsonpath={.items[0].metadata.name}"],
          "env": {
            "KUBECONFIG": "{{ ?input.kubeconfig }}"
          },
          "inline": true
        }
      },
      {
        "id": "describe_pod",
        "tool": "mcp_local",
        "when": {
          "and": [
            { "path": "steps.pod_name.stdout", "exists": true },
            { "path": "steps.pod_name.stdout", "not_equals": "" }
          ]
        },
        "continue_on_error": true,
        "args": {
          "action": "exec",
          "command": "kubectl",
          "args": ["-n", "{{ input.namespace }}", "describe", "pod", "{{ steps.pod_name.stdout }}"],
          "env": {
            "KUBECONFIG": "{{ ?input.kubeconfig }}"
          },
          "inline": true
        }
      },
      {
        "id": "logs",
        "tool": "mcp_local",
        "when": {
          "and": [
            { "path": "input.logs", "equals": true },
            { "path": "steps.pod_name.stdout", "exists": true },
            { "path": "steps.pod_name.stdout", "not_equals": "" }
          ]
        },
        "continue_on_error": true,
        "args": {
          "action": "exec",
          "command": "kubectl",
          "args": ["-n", "{{ input.namespace }}", "logs", "{{ steps.pod_name.stdout }}", "--tail", "{{ input.tail_lines }}"],
          "env": {
            "KUBECONFIG": "{{ ?input.kubeconfig }}"
          },
          "inline": true
        }
      }
    ]
  },
  "k8s.images.list": {
    "description": "List container images used by workloads in a namespace.",
    "tags": ["k8s", "read"],
    "inputs": ["kubeconfig", "namespace"],
    "steps": [
      {
        "id": "images",
        "tool": "mcp_local",
        "args": {
          "action": "exec",
          "command": "sh",
          "args": [
            "-c",
            "kubectl -n {{ input.namespace }} get deploy,sts,ds,job,cronjob -o jsonpath='{..image}' | tr ' ' '\\n' | sort -u"
          ],
          "env": {
            "KUBECONFIG": "{{ ?input.kubeconfig }}"
          },
          "inline": true
        }
      }
    ]
  },
  "gitops.argocd.refresh": {
    "description": "Refresh ArgoCD application and show status.",
    "tags": ["gitops", "argocd", "write"],
    "inputs": ["kubeconfig", "namespace", "app_name", "refresh"],
    "steps": [
      {
        "id": "status_before",
        "tool": "mcp_local",
        "args": {
          "action": "exec",
          "command": "kubectl",
          "args": ["-n", "{{ input.namespace }}", "get", "application", "{{ input.app_name }}", "-o", "wide"],
          "env": {
            "KUBECONFIG": "{{ ?input.kubeconfig }}"
          },
          "inline": true
        }
      },
      {
        "id": "refresh",
        "tool": "mcp_local",
        "when": { "path": "input.refresh", "equals": true },
        "continue_on_error": true,
        "args": {
          "action": "exec",
          "command": "kubectl",
          "args": [
            "-n",
            "{{ input.namespace }}",
            "patch",
            "application",
            "{{ input.app_name }}",
            "--type",
            "merge",
            "-p",
            "{\"metadata\":{\"annotations\":{\"argocd.argoproj.io/refresh\":\"hard\"}}}"
          ],
          "env": {
            "KUBECONFIG": "{{ ?input.kubeconfig }}"
          },
          "inline": true
        }
      },
      {
        "id": "status_after",
        "tool": "mcp_local",
        "when": { "path": "input.refresh", "equals": true },
        "continue_on_error": true,
        "args": {
          "action": "exec",
          "command": "kubectl",
          "args": ["-n", "{{ input.namespace }}", "get", "application", "{{ input.app_name }}", "-o", "wide"],
          "env": {
            "KUBECONFIG": "{{ ?input.kubeconfig }}"
          },
          "inline": true
        }
      }
    ]
  },
  "registry.tags.list": {
    "description": "List repository tags via registry API.",
    "tags": ["registry", "api", "read"],
    "inputs": ["project_name", "target_name", "base_url", "repo"],
    "steps": [
      {
        "id": "tags",
        "tool": "mcp_api_client",
        "args": {
          "action": "request",
          "method": "GET",
          "project": "{{ ?input.project_name }}",
          "target": "{{ ?input.target_name }}",
          "base_url": "{{ ?input.base_url }}",
          "path": "/v2/{{ input.repo }}/tags/list"
        }
      }
    ]
  },
  "repo.snapshot": {
    "description": "Fast repository context: root, branch, status, recent commits, diffstat.",
    "tags": ["repo", "git", "read"],
    "inputs": ["repo_path"],
    "steps": [
      {
        "id": "root",
        "tool": "mcp_local",
        "args": {
          "action": "exec",
          "command": "git",
          "args": ["rev-parse", "--show-toplevel"],
          "cwd": "{{ ?input.repo_path }}",
          "inline": true
        }
      },
      {
        "id": "branch",
        "tool": "mcp_local",
        "args": {
          "action": "exec",
          "command": "git",
          "args": ["branch", "--show-current"],
          "cwd": "{{ steps.root.stdout }}",
          "inline": true
        }
      },
      {
        "id": "status",
        "tool": "mcp_local",
        "args": {
          "action": "exec",
          "command": "git",
          "args": ["status", "--short"],
          "cwd": "{{ steps.root.stdout }}",
          "inline": true
        }
      },
      {
        "id": "diffstat",
        "tool": "mcp_local",
        "args": {
          "action": "exec",
          "command": "git",
          "args": ["diff", "--stat"],
          "cwd": "{{ steps.root.stdout }}",
          "inline": true
        }
      },
      {
        "id": "recent",
        "tool": "mcp_local",
        "args": {
          "action": "exec",
          "command": "git",
          "args": ["log", "-5", "--oneline"],
          "cwd": "{{ steps.root.stdout }}",
          "inline": true
        }
      }
    ]
  },
  "ssh.system_info": {
    "description": "Remote system snapshot via SSH.",
    "tags": ["ssh", "read"],
    "inputs": ["project_name", "target_name"],
    "steps": [
      {
        "id": "info",
        "tool": "mcp_ssh_manager",
        "args": {
          "action": "system_info",
          "project": "{{ input.project_name }}",
          "target": "{{ input.target_name }}"
        }
      }
    ]
  },
  "ssh.health": {
    "description": "Quick SSH reachability check.",
    "tags": ["ssh", "read"],
    "inputs": ["project_name", "target_name"],
    "steps": [
      {
        "id": "check",
        "tool": "mcp_ssh_manager",
        "args": {
          "action": "check_host",
          "project": "{{ input.project_name }}",
          "target": "{{ input.target_name }}"
        }
      }
    ]
  },
  "api.check": {
    "description": "API health check.",
    "tags": ["api", "read"],
    "inputs": ["project_name", "target_name", "base_url", "path"],
    "steps": [
      {
        "id": "check",
        "tool": "mcp_api_client",
        "args": {
          "action": "check",
          "project": "{{ input.project_name }}",
          "target": "{{ input.target_name }}",
          "base_url": "{{ ?input.base_url }}",
          "path": "{{ input.path }}"
        }
      }
    ]
  },
  "preflight.k8s": {
    "description": "Preflight kubectl + kubeconfig connectivity check.",
    "tags": ["k8s", "diagnostic", "read"],
    "inputs": ["kubeconfig", "namespace"],
    "steps": [
      {
        "id": "kubectl_version",
        "tool": "mcp_local",
        "args": {
          "action": "exec",
          "command": "kubectl",
          "args": ["version", "--short"],
          "env": {
            "KUBECONFIG": "{{ ?input.kubeconfig }}"
          },
          "inline": true
        }
      },
      {
        "id": "cluster_access",
        "tool": "mcp_local",
        "args": {
          "action": "exec",
          "command": "kubectl",
          "args": ["get", "ns", "--request-timeout=5s"],
          "env": {
            "KUBECONFIG": "{{ ?input.kubeconfig }}"
          },
          "inline": true
        }
      }
    ]
  },
  "preflight.ssh": {
    "description": "Preflight SSH connectivity and auth.",
    "tags": ["ssh", "diagnostic", "read"],
    "inputs": ["project_name", "target_name"],
    "steps": [
      {
        "id": "check",
        "tool": "mcp_ssh_manager",
        "args": {
          "action": "check_host",
          "project": "{{ input.project_name }}",
          "target": "{{ input.target_name }}"
        }
      }
    ]
  },
  "preflight.node": {
    "description": "Preflight Node.js and pnpm versions for repo.",
    "tags": ["node", "diagnostic", "read"],
    "inputs": ["repo_path"],
    "steps": [
      {
        "id": "node_version",
        "tool": "mcp_local",
        "args": {
          "action": "exec",
          "command": "node",
          "args": ["-v"],
          "cwd": "{{ ?input.repo_path }}",
          "inline": true
        }
      },
      {
        "id": "pnpm_version",
        "tool": "mcp_local",
        "continue_on_error": true,
        "args": {
          "action": "exec",
          "command": "pnpm",
          "args": ["-v"],
          "cwd": "{{ ?input.repo_path }}",
          "inline": true
        }
      },
      {
        "id": "node_engine",
        "tool": "mcp_local",
        "continue_on_error": true,
        "args": {
          "action": "exec",
          "command": "node",
          "args": [
            "-e",
            "const fs=require('fs');const p=require('path');const file=p.join(process.cwd(),'package.json');if(fs.existsSync(file)){const pkg=require(file);console.log(pkg.engines?.node||'');}"
          ],
          "cwd": "{{ ?input.repo_path }}",
          "inline": true
        }
      }
    ]
  }
}
